using System.Collections.Generic;
using System.IO;
using System.Net;
using FlyZonesMap.Models;
using System.Runtime.Serialization.Json;
using System.Web.Script.Serialization;
using Newtonsoft.Json.Linq;
using FlyZonesMap.Infrastructure.Repositories;
using AutoMapper;

using Place = FlyZonesMap.Models.Place;
using PlaceDbo = FlyZonesMap.Data.Entities.Place;

namespace FlyZonesMap.Service
{
    public class PlaceService: IPlaceService
    {

        string requestExample = " { \"html_attributions\" : [], \"next_page_token\" : \"CoQC-wAAAFtENcxC44cgJEQ4DKcvw9R2Ay4Vy-saIAzDy0s-NJdbFp8mziW9q1sF2iQULACIuSIOwEHpaV9TSun2p_YnDEjahAY3T29GOyV0gah7HtRR3khIOrBJn4I4pUuTpgDPAcE4Ath2sGUOJwErPaoleuJSWLK4a_SXXiCzqWlEniTPNHuI6GoEtU75g_EyjugGNr-Y7dACaRS6J9b023lFsMAZ8zTouNyeU9O_-EA3RiOzM_Wi0xgzsOjE-zxN9skGCh5o79UhLEK3wqy2fU7BWjNGjxdr74nUTb16zEax4E7vUaZYkGwHxYFAJiuIgI8CkJiMYZH8sG8wJxXLPgO8N7QSECqUQV5cliXKgzBP5kINgHYaFP6UgR284xHEk0B_72Ryc3OA5VSJ\", \"results\" : [ { \"formatted_address\" : \"Boryspil', Kyiv Oblast, 08307\", \"geometry\" : { \"location\" : { \"lat\" : 50.33822199999999, \"lng\" : 30.8939274 }, \"viewport\" : { \"northeast\" : { \"lat\" : 50.35874545, \"lng\" : 30.89568107989272 }, \"southwest\" : { \"lat\" : 50.33138085, \"lng\" : 30.89298142010727 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"b0aa5beaf8559c738dfa72116436fadf46be40c8\", \"name\" : \"Kyiv Boryspil International Airport\", \"opening_hours\" : { \"open_now\" : true }, \"photos\" : [ { \"height\" : 3120, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/114467753090850540176/photos\">A Google User</a>\" ], \"photo_reference\" : \"CmRaAAAAZGkIICFYF7yfCltVNODkdxauNG_qeBXvqC7x2sSBqsJcGLwnkHwUhAwravgbffg6z4WGAcTbGTmFUKfjgygE0lUcaYaiD3CrZrPdREqE4B9PVHPppWDijGZ-VPAkGN5XEhCHWaYx9VUQj9q5kdZa8uRUGhSGAnNk8VUiab-otOUOUsxc0HDdVw\", \"width\" : 4160 } ], \"place_id\" : \"ChIJ0cV-Zvro1EAR2nDYSV0sCmk\", \"plus_code\" : { \"compound_code\" : \"8VQV+7H Boryspil', Kyiv Oblast\", \"global_code\" : \"9G2G8VQV+7H\" }, \"rating\" : 3.9, \"reference\" : \"ChIJ0cV-Zvro1EAR2nDYSV0sCmk\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 2747 }, { \"formatted_address\" : \"Odesa, Odessa Oblast\", \"geometry\" : { \"location\" : { \"lat\" : 46.4298271, \"lng\" : 30.6774409 }, \"viewport\" : { \"northeast\" : { \"lat\" : 46.45169619999999, \"lng\" : 30.67825595000001 }, \"southwest\" : { \"lat\" : 46.42253740000001, \"lng\" : 30.67499575 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"2434bd63e8bcd4407753302be5b3f5f15a64c776\", \"name\" : \"Odessa International Airport\", \"opening_hours\" : { \"open_now\" : true }, \"photos\" : [ { \"height\" : 1836, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/118019186630869556999/photos\">Wladislaw</a>\" ], \"photo_reference\" : \"CmRaAAAAHlIfsMAn60kY2fAdr1OJm6M-U41jB2J-81PzB1O5YDjisk8aX9IaBiQxqyxA20iG-nC7uJXMUvz-0QmUayf1zfhL5LAqZAQI0gdWJpSPbLSz9UXMlGwVXhMH1C_8_8kAEhC_zV0SSu29dbaDh2vhlvw8GhRdqYpE4vChGDeJ9K9XzFLfgfGZ5g\", \"width\" : 3264 } ], \"place_id\" : \"ChIJ00objuQyxkARwxOHzVyVeuI\", \"plus_code\" : { \"compound_code\" : \"CMHG+WX Odesa, Odessa Oblast\", \"global_code\" : \"8GRGCMHG+WX\" }, \"rating\" : 2.8, \"reference\" : \"ChIJ00objuQyxkARwxOHzVyVeuI\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 688 }, { \"formatted_address\" : \"Vulytsya Medova, 2, Kyiv, 02000\", \"geometry\" : { \"location\" : { \"lat\" : 50.4119806, \"lng\" : 30.44329239999999 }, \"viewport\" : { \"northeast\" : { \"lat\" : 50.41345122989272, \"lng\" : 30.44479452989272 }, \"southwest\" : { \"lat\" : 50.41075157010727, \"lng\" : 30.44209487010728 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"fc9e8a5fe60a9fcc8d9a4417717e266fb6a053fd\", \"name\" : \"Kyiv International Airport (Zhuliany)\", \"photos\" : [ { \"height\" : 3024, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/104051523749131015540/photos\">user zz</a>\" ], \"photo_reference\" : \"CmRaAAAAEVAVLYuzgOjM-woEOeJg5cc89ysCPqKrhLLawBXA-XHRZahIpqdNNPWGsn_tipp8_UJo9JzdsRXsgi5P-jbQTCQ4gZyZ_Btu9738d0XRRY9iO5a-uC_9LG4-WmFqj65ZEhB8eU3DrYSe0xETHuauPtGVGhQ5bvNLvBIXHzvhBiHZFLjVEHyCNQ\", \"width\" : 4032 } ], \"place_id\" : \"ChIJy51DjUfJ1EARiJ9SmctrZic\", \"plus_code\" : { \"compound_code\" : \"CC6V+Q8 Kyiv, Kyiv city\", \"global_code\" : \"9G2GCC6V+Q8\" }, \"rating\" : 4, \"reference\" : \"ChIJy51DjUfJ1EARiJ9SmctrZic\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 1525 }, { \"formatted_address\" : \"Calea Bucurestilor 224E, Otopeni 075150, Romania\", \"geometry\" : { \"location\" : { \"lat\" : 44.5707306, \"lng\" : 26.0844123 }, \"viewport\" : { \"northeast\" : { \"lat\" : 44.57556395, \"lng\" : 26.0917192 }, \"southwest\" : { \"lat\" : 44.56465215000001, \"lng\" : 26.0624916 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"0280616479dd542332d6aa08b9f6abda0f9d432f\", \"name\" : \"Henri Coanda International Airport\", \"opening_hours\" : { \"open_now\" : false }, \"photos\" : [ { \"height\" : 3456, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/101600112900992139329/photos\">Mihai Iancu</a>\" ], \"photo_reference\" : \"CmRaAAAAQRfEWzFRQaq2sn58GpuDbffS8IpIw4vU3-ClURprm3lixBVRWMyZrgtIBVqxQ03DO8EIrNMRAWbXiuHzfH0_by6UHccSueA7J3ailUDVsQHewBWPTapsx3msGOMlF6FtEhB4MOzpC4RoUCgVBYaVqyZUGhROvL65_4xVsQj-7cg63R-GeNLdgA\", \"width\" : 4608 } ], \"place_id\" : \"ChIJd49YtoEcskARfodtna1dThE\", \"plus_code\" : { \"compound_code\" : \"H3CM+7Q Otopeni, Romania\", \"global_code\" : \"8GP8H3CM+7Q\" }, \"rating\" : 3.4, \"reference\" : \"ChIJd49YtoEcskARfodtna1dThE\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 1923 }, { \"formatted_address\" : \"Romashkina St, 1, Kharkiv, Kharkivs'ka oblast, 61000\", \"geometry\" : { \"location\" : { \"lat\" : 49.92183, \"lng\" : 36.279988 }, \"viewport\" : { \"northeast\" : { \"lat\" : 49.92270375, \"lng\" : 36.28094377989272 }, \"southwest\" : { \"lat\" : 49.91920875000001, \"lng\" : 36.27824412010728 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"8c1a98f7e02cb05e6fc102af3a958656b31a02cf\", \"name\" : \"International Airport Kharkiv\", \"photos\" : [ { \"height\" : 2304, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/101825285887613695472/photos\">Кирилл Светлицкий</a>\" ], \"photo_reference\" : \"CmRaAAAANqviz_BfpH6nLD0_Hc7rk_beEIBM-NlwMbjFd2kiLqoi_1BEVtzPjX89zQ5KdYUpN715FtjzG5_lzl-gC3Xb5umMJnRtjap8LUIyux7jkCLvoMJIk62RpRnrU0TlpcG7EhDzoB42Cwa027NK7Bavacy4GhSfjl_21_n_cuTr7vN0qV4eysBEdA\", \"width\" : 4096 } ], \"place_id\" : \"ChIJ01SmsCgLJ0ER9lfv6vhNKi0\", \"plus_code\" : { \"compound_code\" : \"W7CH+PX Kharkiv, Kharkiv Oblast\", \"global_code\" : \"8GXRW7CH+PX\" }, \"rating\" : 4.3, \"reference\" : \"ChIJ01SmsCgLJ0ER9lfv6vhNKi0\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 455 }, { \"formatted_address\" : \"Smilyans'ka St, 168, Cherkasy, Cherkas'ka oblast\", \"geometry\" : { \"location\" : { \"lat\" : 49.402612, \"lng\" : 32.0125297 }, \"viewport\" : { \"northeast\" : { \"lat\" : 49.40379172989272, \"lng\" : 32.01600115 }, \"southwest\" : { \"lat\" : 49.40109207010728, \"lng\" : 32.01137255 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"38a86d711ecbc857129c45bd1179264fc4f1fccd\", \"name\" : \"International airport \"Cherkasy\"\", \"photos\" : [ { \"height\" : 1200, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/103441452682259882061/photos\">Dmitry Korolenko</a>\" ], \"photo_reference\" : \"CmRaAAAAbOZ_nON1jSeH_-NWhLfcGg5Nqxjv17UxUV3tMIxvHI4zcPAozv3QkLJEesoAHV2QuyNcvtbNL7Uf0XPN6CIFtpGTaxK1UNmdKpI0rNJSqEvbcMMdNyshUPvkb4fVnQKsEhCfFHbNuIMt8DLBiscz-QsZGhSy1facBE8rvDh7BRRrrrOqo5leVA\", \"width\" : 1600 } ], \"place_id\" : \"ChIJVd90bK1O0UARyIR-7YfLJKo\", \"plus_code\" : { \"compound_code\" : \"C237+22 Cherkasy, Cherkasy Oblast\", \"global_code\" : \"8GXJC237+22\" }, \"rating\" : 3.4, \"reference\" : \"ChIJVd90bK1O0UARyIR-7YfLJKo\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 57 }, { \"formatted_address\" : \"Dnipropetrovsk Oblast\", \"geometry\" : { \"location\" : { \"lat\" : 48.0463072, \"lng\" : 33.2145882 }, \"viewport\" : { \"northeast\" : { \"lat\" : 48.04718282989272, \"lng\" : 33.21864855000001 }, \"southwest\" : { \"lat\" : 48.04448317010728, \"lng\" : 33.21323475 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"2f0ba2570173d862c79083cc0a1683a7459aeeac\", \"name\" : \"Kryvyi Rih International Airport\", \"photos\" : [ { \"height\" : 300, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/103136006784665838065/photos\">Виктор Пятов</a>\" ], \"photo_reference\" : \"CmRaAAAAw4obipLYTkPKQkC5_gsB6F2bBp0-3asDlJTHP0J8SEFZyTG0_YWPPRIhfv3olqNwSqj0oGQM8h8pS-nxAg44QzSAktY7iLYInn393Ek7mw-0VrJBn_3mxKPgCGKd3XLJEhACTBJHCaP3Q4Tg-lbKXpVHGhSbmpl1cTL56PzHKWu0RJP1fU_zPw\", \"width\" : 500 } ], \"place_id\" : \"ChIJ4aW-4hro2kARWDByWkDM3VQ\", \"plus_code\" : { \"compound_code\" : \"26W7+GR Ternivka, Dnipropetrovsk Oblast\", \"global_code\" : \"8GWM26W7+GR\" }, \"rating\" : 3.6, \"reference\" : \"ChIJ4aW-4hro2kARWDByWkDM3VQ\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 46 }, { \"formatted_address\" : \"Liubinska St, 168, Lviv, L'vivs'ka oblast, 79000\", \"geometry\" : { \"location\" : { \"lat\" : 49.81344310000001, \"lng\" : 23.9595504 }, \"viewport\" : { \"northeast\" : { \"lat\" : 49.81871649999999, \"lng\" : 23.9617708 }, \"southwest\" : { \"lat\" : 49.81168530000002, \"lng\" : 23.9558748 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"bc2542ca01e694f6c34852bbbd6aa5cb33608907\", \"name\" : \"Lviv Danylo Halytskyi International Airport\", \"photos\" : [ { \"height\" : 2340, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/101033755655952277540/photos\">Roman Borshovskyy</a>\" ], \"photo_reference\" : \"CmRaAAAAHyqjI0UZRHbOvZjbgtrpx50Bm6_dJRNbScASkTcTO659mtjiwGpqSYQ6u297Fk-W9KlVlWi92eVN7SDMvILgsC-cNGzB87_CeGTVC4xAYtuIcUSvnGEMXSd89ekNdEVIEhAFOLwAbDUDNH0c8dTJKPwfGhTU8kXJ3jM9JoCwkHt8TSIm60G4cA\", \"width\" : 4160 } ], \"place_id\" : \"ChIJA6djeW7dOkcRmf0bzbyv47I\", \"plus_code\" : { \"compound_code\" : \"RX75+9R Lviv, Lviv Oblast\", \"global_code\" : \"8GX5RX75+9R\" }, \"rating\" : 4.3, \"reference\" : \"ChIJA6djeW7dOkcRmf0bzbyv47I\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 862 }, { \"formatted_address\" : \"Київське шосе, 9, Balovne, Миколаївська, 56664\", \"geometry\" : { \"location\" : { \"lat\" : 47.056648, \"lng\" : 31.918101 }, \"viewport\" : { \"northeast\" : { \"lat\" : 47.05813634999998, \"lng\" : 31.92352065 }, \"southwest\" : { \"lat\" : 47.05218295000001, \"lng\" : 31.91629444999999 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"d69b694a5b6b61276fc0a1c022972914ec4a327b\", \"name\" : \"Mykolaiv international airport\", \"photos\" : [ { \"height\" : 3456, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/111222143469775912815/photos\">Vаdim Melnitskiy</a>\" ], \"photo_reference\" : \"CmRaAAAAzqKckxL21ttZ_FRwd_AecIHQfUZ7obuRKYn2GlaI0TwdgLAcWqaSdgmIoFKAaxKleIcLHRsFJuw2k1aVsdJkV8GDSxO2FF78_-5xAfApmspATouwhM-lbEJ6uZ8k5DsHEhDdnMQ7Yd3t6umlCoMACVpqGhSEwniQrMsyWS6yzyDz3sF0sa8jLA\", \"width\" : 4608 } ], \"place_id\" : \"ChIJp9eBqnW4xUARmRfaJIBUhM8\", \"plus_code\" : { \"compound_code\" : \"3W49+M6 Balovne, Mykolaiv Oblast\", \"global_code\" : \"8GVH3W49+M6\" }, \"rating\" : 3.4, \"reference\" : \"ChIJp9eBqnW4xUARmRfaJIBUhM8\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 65 }, { \"formatted_address\" : \"ulitsa Korolenko, 1, Kirovohrad, Kirovohrads'ka oblast, 25000\", \"geometry\" : { \"location\" : { \"lat\" : 48.5446147, \"lng\" : 32.2822042 }, \"viewport\" : { \"northeast\" : { \"lat\" : 48.54601787989273, \"lng\" : 32.28415957989272 }, \"southwest\" : { \"lat\" : 48.54331822010728, \"lng\" : 32.28145992010727 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"7d4c4dac0be8a26db6430094a0c42320df49113c\", \"name\" : \"Aeroport Kropyvnytskyi\", \"photos\" : [ { \"height\" : 2448, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/111356863106399040493/photos\">Ілля Буханець</a>\" ], \"photo_reference\" : \"CmRaAAAAqc2wHcFQDsYjn-0quqIwjY0iB2jNp5p0HdtXWTUG7WJYD04Wc1M2aq0P1DRDXrboXbbwdwBf792XKWnmZAVRHcg-EBIg19uJagCB-oDeroJubDu7n5quEjLarDEH6cqUEhCZBgvNbK5PSblRjvlUcG-7GhTK9q6eD28qHlvTtzdBn1xxYZIq6Q\", \"width\" : 3264 } ], \"place_id\" : \"ChIJp6sJYRNd0EAR0P6-jvDH-ig\", \"plus_code\" : { \"compound_code\" : \"G7VJ+RV Kropyvnytskyi, Kirovohrad Oblast\", \"global_code\" : \"8GWJG7VJ+RV\" }, \"rating\" : 3.7, \"reference\" : \"ChIJp6sJYRNd0EAR0P6-jvDH-ig\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 49 }, { \"formatted_address\" : \"Т0231 v. Gavryshivka, Vinnytsia Oblast, 23202\", \"geometry\" : { \"location\" : { \"lat\" : 49.2422456, \"lng\" : 28.6058666 }, \"viewport\" : { \"northeast\" : { \"lat\" : 49.2450589, \"lng\" : 28.61422315000001 }, \"southwest\" : { \"lat\" : 49.23380570000001, \"lng\" : 28.58079694999999 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"ed027d981551a3fd4a676d4533d5717dbf81cc13\", \"name\" : \"Vinnytsia Airport\", \"photos\" : [ { \"height\" : 3024, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/115608148698952656358/photos\">Олександр Климчук</a>\" ], \"photo_reference\" : \"CmRaAAAA73wX7G7f4ogBkLbQAaKwmzhdgv78RM35e9m-6dwSgmP_0EB4MIhBwoOYcDbSuRSea9DZ1ZhktuNEYGzuxETV8SnBIkAb38_H5V93HXEErpiiQPtaf8sUlfRFIf2oe-EyEhCJEhkccZ4kAfJaxzvLXAlgGhSvh9jC3f5R-pbf2vfl2mgfEdGkmQ\", \"width\" : 4032 } ], \"place_id\" : \"ChIJwaHZD_hPLUcRVZUvb2PmIEg\", \"plus_code\" : { \"compound_code\" : \"6JR4+V8 Havryshivka, Vinnytsia Oblast\", \"global_code\" : \"8GXC6JR4+V8\" }, \"rating\" : 3.6, \"reference\" : \"ChIJwaHZD_hPLUcRVZUvb2PmIEg\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 85 }, { \"formatted_address\" : \"Dacia Blvd 80/3, Chisinau 2026, Moldova\", \"geometry\" : { \"location\" : { \"lat\" : 46.935168, \"lng\" : 28.935516 }, \"viewport\" : { \"northeast\" : { \"lat\" : 46.93665537989272, \"lng\" : 28.93689532989272 }, \"southwest\" : { \"lat\" : 46.93395572010728, \"lng\" : 28.93419567010727 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"4084858385d9f238780f3fb7122f26e40b41d0e0\", \"name\" : \"Chi?inau International Airport\", \"photos\" : [ { \"height\" : 3024, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/112531263548337899268/photos\">Gabriel Bobon</a>\" ], \"photo_reference\" : \"CmRaAAAANOI2AmkRHisRHx5Dh6okCvwwPA16eamPu4DG4a0ICFjrg9sXy00rfTi8M-IG9g63weWQUKrg0_m_Jrnw7hbYI_3ORfIJ7E3VtBFaB8dwTtfrTGsTx4j_nzuFoUVZdXaOEhCUcZrwDySzxaWrLo4xiGQEGhQXZ9wSvtguH3iIx7_QzemV5xKrKA\", \"width\" : 4032 } ], \"place_id\" : \"ChIJz_uTPyl4yUARJGdkHHYJSjM\", \"plus_code\" : { \"compound_code\" : \"WWPP+36 Chisinau, Moldova\", \"global_code\" : \"8GRCWWPP+36\" }, \"rating\" : 4.1, \"reference\" : \"ChIJz_uTPyl4yUARJGdkHHYJSjM\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 587 }, { \"formatted_address\" : \"вул. Блакитна, 4 м, Zaporizhzhia, Zaporizhia Oblast, 69013\", \"geometry\" : { \"location\" : { \"lat\" : 47.8732128, \"lng\" : 35.3018459 }, \"viewport\" : { \"northeast\" : { \"lat\" : 47.8795589, \"lng\" : 35.30997494999998 }, \"southwest\" : { \"lat\" : 47.8552701, \"lng\" : 35.27745875000002 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"ad10bcd8cb44c62fc39f43a176e05ce26fb1038d\", \"name\" : \"International Airport Zaporizhzhya\", \"photos\" : [ { \"height\" : 3024, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/100886201170868689585/photos\">Максим Белокопытов</a>\" ], \"photo_reference\" : \"CmRaAAAAp_e_TUQYkPiGd8mq1yTKbnPydWuJ76OHtiWEs7wVG1Gi9YwSS_wOWzkkAukyTyQ_hsKVNJsESKSATMaNGhzgKIX-qaD9p5cULMEY8V3TitrA7ROSsZ3YXXslBwiwEh2uEhAy7Z-3OYIRJxWxQII8GrzgGhTr2uxxuVVZZhwWJdZcu0u6JDbmsw\", \"width\" : 4032 } ], \"place_id\" : \"ChIJQUt609VC3EARKiE4-04nZOo\", \"plus_code\" : { \"compound_code\" : \"V8F2+7P Zaporizhzhia, Zaporizhia Oblast\", \"global_code\" : \"8GVQV8F2+7P\" }, \"rating\" : 2.5, \"reference\" : \"ChIJQUt609VC3EARKiE4-04nZOo\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 305 }, { \"formatted_address\" : \"Kropyvnytskyi, Kirovohrad Oblast, 25000\", \"geometry\" : { \"location\" : { \"lat\" : 48.53043719999999, \"lng\" : 32.2896081 }, \"viewport\" : { \"northeast\" : { \"lat\" : 48.53170622989273, \"lng\" : 32.29090157989272 }, \"southwest\" : { \"lat\" : 48.52900657010728, \"lng\" : 32.28820192010728 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"6751cf43afe68177afb9a8b1ea39fab7bb89fed5\", \"name\" : \"Airport Kropyvnytskyi\", \"opening_hours\" : { \"open_now\" : true }, \"photos\" : [ { \"height\" : 480, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/117961926854351924437/photos\">Юрий Заярнюк</a>\" ], \"photo_reference\" : \"CmRaAAAAyRrog8-whL-CnRTQQSkRPT1eeLlFzJQfi0pqtsHGjUmYowdf3Drh1WIu7JpRUvpRETSKlJRFzvbk8xmOHhnCbxzJOOAgx0Z8xHLgBJw6SWh2zA5vaOZ2yZkugE3VsBaPEhDEGv2ClDvEt5N1x_UjuSkHGhRyqQyp5qAtZXYMRs3U5ixXhwPqJA\", \"width\" : 640 } ], \"place_id\" : \"ChIJuxhmrkRd0EARXjETySnlb3s\", \"plus_code\" : { \"compound_code\" : \"G7JQ+5R Kropyvnytskyi, Kirovohrad Oblast\", \"global_code\" : \"8GWJG7JQ+5R\" }, \"rating\" : 4, \"reference\" : \"ChIJuxhmrkRd0EARXjETySnlb3s\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 8 }, { \"formatted_address\" : \"Bila Tserkva, Kyiv Oblast, 09100\", \"geometry\" : { \"location\" : { \"lat\" : 49.8019371, \"lng\" : 30.0339758 }, \"viewport\" : { \"northeast\" : { \"lat\" : 49.80340132989272, \"lng\" : 30.03582907989272 }, \"southwest\" : { \"lat\" : 49.80070167010728, \"lng\" : 30.03312942010728 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"d4e5f65d9751c97140d3b76c677318a1775c5663\", \"name\" : \"Bila Tserkva Airport UKBC\", \"photos\" : [ { \"height\" : 1280, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/112642957433419421898/photos\">Yevhenii Dzhus</a>\" ], \"photo_reference\" : \"CmRaAAAATeZwiinQiHS5N6d0jIY7zizMCRSDdDMavvebE7snbbCWSpdUvNMx6fMUKdtUpw1QEInHPIHxwX_42tRIrGAvZXv54JLU9BRMONPdv1OuKIz0tUqiOGQXjd9aD0yRpoEQEhARSFg165kzu2BRn1yG7_F2GhS_vO3l1JbaJrHg7ebXxWdf9f8spg\", \"width\" : 960 } ], \"place_id\" : \"ChIJfSZtNUNB00AR0sDiKDOFzho\", \"plus_code\" : { \"compound_code\" : \"R22M+QH Bila Tserkva, Kyiv Oblast\", \"global_code\" : \"8GXGR22M+QH\" }, \"rating\" : 4.5, \"reference\" : \"ChIJfSZtNUNB00AR0sDiKDOFzho\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 16 }, { \"formatted_address\" : \"Kherson, Kherson Oblast, 73000\", \"geometry\" : { \"location\" : { \"lat\" : 46.6722, \"lng\" : 32.5084912 }, \"viewport\" : { \"northeast\" : { \"lat\" : 46.67301057989272, \"lng\" : 32.51223895 }, \"southwest\" : { \"lat\" : 46.67031092010728, \"lng\" : 32.50724195000001 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"187d5817e24456d31c7ff677d20741bc2edc7536\", \"name\" : \"Kherson International Airport\", \"opening_hours\" : { \"open_now\" : true }, \"photos\" : [ { \"height\" : 1836, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/106967310324556287812/photos\">Aleksander Zaporozetc</a>\" ], \"photo_reference\" : \"CmRaAAAAwea_xaoMeftgticCsMkQvFdxcG7HF89RFMhgujWbqOA1D9iriX6ftxoMQZ-UVPoLYhQWDOnE5hiophZhAPvLYidZC-DA1NHFAX3XrjPQgaAN6h71bzJd50yuZ0lwMpb_EhCZZfE_Ips1-ITJ8H85Rp60GhRCADcB30f86rj9mSjXtirmsDyhug\", \"width\" : 3264 } ], \"place_id\" : \"ChIJDwrsLPIZxEAR10quS5vWqTo\", \"plus_code\" : { \"compound_code\" : \"MGC5+V9 Kherson, Kherson Oblast\", \"global_code\" : \"8GRJMGC5+V9\" }, \"rating\" : 4, \"reference\" : \"ChIJDwrsLPIZxEAR10quS5vWqTo\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 136 }, { \"formatted_address\" : \"Chisinau, Moldova\", \"geometry\" : { \"location\" : { \"lat\" : 46.92789759999999, \"lng\" : 28.9341491 }, \"viewport\" : { \"northeast\" : { \"lat\" : 46.92924742989272, \"lng\" : 28.93549892989272 }, \"southwest\" : { \"lat\" : 46.92654777010728, \"lng\" : 28.93279927010728 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"c942beef71282f7b41c550bb47a6e98c6c917ec3\", \"name\" : \"Kishinev Airport (KIV) Runway\", \"opening_hours\" : { \"open_now\" : true }, \"photos\" : [ { \"height\" : 1746, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/103462315695972997139/photos\">kirkdis *</a>\" ], \"photo_reference\" : \"CmRaAAAAcK4LoSYSazvUL_cqHkkOtbDzVy-Y7Qc350829PTHAjEYp7JIQbpUVG9_bgLgjFV9gbEzzCdrA9HoxMpnoOI9_oaiS9JStHig-hcknFtaMGF7e5D4P48IM-gTkNDvA_x9EhAF5BCj6MW4jGZk9eXgKDvCGhTt_rSLZ8jwPuyZcVBjXlzFY3JB9Q\", \"width\" : 3104 } ], \"place_id\" : \"ChIJxbTOBIh3yUARXhPtz5rMMCU\", \"plus_code\" : { \"compound_code\" : \"WWHM+5M Chisinau, Moldova\", \"global_code\" : \"8GRCWWHM+5M\" }, \"rating\" : 4.8, \"reference\" : \"ChIJxbTOBIh3yUARXhPtz5rMMCU\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 14 }, { \"formatted_address\" : \"Zwirki i Wigury 1, 00-001 Warszawa, Poland\", \"geometry\" : { \"location\" : { \"lat\" : 52.1672369, \"lng\" : 20.9678911 }, \"viewport\" : { \"northeast\" : { \"lat\" : 52.17481355, \"lng\" : 20.9800588 }, \"southwest\" : { \"lat\" : 52.16471135, \"lng\" : 20.9638352 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"9415e94d967e0e1474a4856e56f3085550b412c2\", \"name\" : \"Warsaw Chopin Airport\", \"photos\" : [ { \"height\" : 3264, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/112321891114994397088/photos\">Peter Smith</a>\" ], \"photo_reference\" : \"CmRaAAAAU0ZZQUibl8PFQwi9f3vkfCr-jlr8kgx7DIWh4uxuYoZeCrfkgO_nG7XrFgHo2rjbbgOEctip3e9bnM4UKZHO_LAV0-VrUQp15P2JBw8TlRAna_h6nVW7BBTRZIeuAj3ZEhAgmTPddTcwIQ--f3KIbCVzGhQwNpj-fc52j-UU_3pqmvlBJyqdTA\", \"width\" : 2448 } ], \"place_id\" : \"ChIJ41zpQhwzGUcR0ehDaKL1xSI\", \"plus_code\" : { \"compound_code\" : \"5X89+V5 Warsaw, Poland\", \"global_code\" : \"9G425X89+V5\" }, \"rating\" : 3.8, \"reference\" : \"ChIJ41zpQhwzGUcR0ehDaKL1xSI\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 4599 }, { \"formatted_address\" : \"Р04, Kyivs'ka oblast\", \"geometry\" : { \"location\" : { \"lat\" : 49.3921223, \"lng\" : 30.7242966 }, \"viewport\" : { \"northeast\" : { \"lat\" : 49.39386122989272, \"lng\" : 30.72539887989272 }, \"southwest\" : { \"lat\" : 49.39116157010727, \"lng\" : 30.72269922010727 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"eafbe373b00223e85525d3fd17f29d867e95bcd2\", \"name\" : \"Aerodrom \"Medvyn\"\", \"place_id\" : \"ChIJ7ztWoM2700AR7WA-hh70Vo8\", \"plus_code\" : { \"compound_code\" : \"9PRF+RP Medvyn, Kyiv Oblast\", \"global_code\" : \"8GXG9PRF+RP\" }, \"rating\" : 0, \"reference\" : \"ChIJ7ztWoM2700AR7WA-hh70Vo8\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 0 }, { \"formatted_address\" : \"Ukrainka, Kirovohrad Oblast, 27635\", \"geometry\" : { \"location\" : { \"lat\" : 48.5609858, \"lng\" : 32.3905395 }, \"viewport\" : { \"northeast\" : { \"lat\" : 48.5659715, \"lng\" : 32.39247852989271 }, \"southwest\" : { \"lat\" : 48.5593239, \"lng\" : 32.38977887010727 } } }, \"icon\" : \"https://maps.gstatic.com/mapfiles/place_api/icons/airport-71.png\", \"id\" : \"c0f68dab498bbfee8da7c4cce0150a763e6055a5\", \"name\" : \"Viys?kovyy Aerodrom Kanatovo\", \"photos\" : [ { \"height\" : 466, \"html_attributions\" : [ \"<a href=\"https://maps.google.com/maps/contrib/102574275547708183150/photos\">Dmitry Parfenov</a>\" ], \"photo_reference\" : \"CmRaAAAA-6P91bfsIjtjiYllNj7EyZbRKnz106AsJMrCvcUGGpT4OTROkybMt6bBAn_B8Y5Prrcqi6I4jNu85X4zp7rhDprCJKsHWId78utSIkTaXbDpqjaRNW04LhBEIJ7-xHH1EhClpbegpLdq0wJuym8Acig2GhSgdXk2m4S_7MGPowpxOZf74GT2WQ\", \"width\" : 720 } ], \"place_id\" : \"ChIJe8Z__zZn0EARbaxW2BthsjY\", \"plus_code\" : { \"compound_code\" : \"H96R+96 Veselivka, Kirovohrad Oblast\", \"global_code\" : \"8GWJH96R+96\" }, \"rating\" : 4, \"reference\" : \"ChIJe8Z__zZn0EARbaxW2BthsjY\", \"types\" : [ \"airport\", \"point_of_interest\", \"establishment\" ], \"user_ratings_total\" : 2 } ], \"status\" : \"OK\" } ";
        string googleUrl = "https://maps.googleapis.com/maps/api/place/textsearch/json?key=AIzaSyAtGhClpk9gDmflMhxPhwnNpZ0JyRdx6Lw&input=airport&region=ua";
        private readonly IPlaceRepository _placeRepository;

        public PlaceService(IPlaceRepository placeRepository)
        {
            _placeRepository = placeRepository;
        }

        public string GetRequest(string url)
        {
            WebRequest request = WebRequest.Create(url);

            WebResponse response = request.GetResponse();

            Stream data = response.GetResponseStream();

            StreamReader reader = new StreamReader(data);

            // json-formatted string from maps api
            string responseFromServer = reader.ReadToEnd();
            response.Close();
            return responseFromServer;
        }

        public List<Place> DeserializeData(string json)
        {
            var returnedPlaces = new List<Place>();

            JObject jo = JObject.Parse(json);
            var joResult = jo["results"];
            foreach (var j in joResult)
            {
                var newPlace = new Place()
                {
                    FormattedAddress = (string) j["formatted_address"],
                    Id = (string) j["id"],
                    Location = new Location()
                    {
                        Lat = (double) j["geometry"]["location"]["lat"],
                        Lng = (double) j["geometry"]["location"]["lng"],
                    },
                    Name = (string) j["name"],
                    PlaceId = (string) j["place_id"],
                    Reference = (string) j["reference"],
                    Type = (string) j["types"][0],
                    Viewport = new Viewport()
                    {
                        NortheastLocation = new Location()
                        {
                            Lat = (double) j["geometry"]["viewport"]["northeast"]["lat"],
                            Lng = (double) j["geometry"]["viewport"]["northeast"]["lng"]
                        },
                        SouthwestLocation = new Location()
                        {
                            Lat = (double)j["geometry"]["viewport"]["southwest"]["lat"],
                            Lng = (double)j["geometry"]["viewport"]["southwest"]["lng"]
                        },
                    }
                };

                returnedPlaces.Add(newPlace);
            }
            return returnedPlaces;
        }

        public void SavePlaces(List<Place> places)
        {
            var mappedPlaces = Mapper.Map<List<Place>,List<PlaceDbo>>(places);
            _placeRepository.SavePlaces(mappedPlaces);
        }
    }
}